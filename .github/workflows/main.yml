name: 'BUILD'

on:
  workflow_dispatch:
    inputs:
      tag:
        required: true

jobs:
  source_build:
    name: 'Source'
    runs-on: [ubuntu-22.04]
    permissions:
      contents: write
    defaults:
      run:
        shell: bash
        working-directory: 'obs-studio'
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v3
        with:
          repository: 'obsproject/obs-studio'
          submodules: 'recursive'
          path: 'obs-studio'
          fetch-depth: 0

      - name: 'Create source artifact'
        run: |
          git checkout tags/${{ github.event.inputs.tag }}
          prefix=obs-studio-${{ github.event.inputs.tag }}
          commit_date=$(git show -s --format=%cI ${commitHash})
          outfile=${prefix}.tar.gz
          ARTIFACT_NAME=${outfile}
          outfile=${{ github.workspace }}/${outfile}
          echo "outfile: $outfile"
          echo "artifact: $ARTIFACT_NAME"
          # create a tarball with *all* the sources
          # - prefix paths with 'obs-studio/' (since we are creating the tarball from within the source dir)
          # - exclude all repository files
          # - make the tarball reproducible
          tar -cvzf ${outfile}  --transform='s|^\.|obs-studio|'  --exclude-vcs --exclude-vcs-ignores --exclude '.git*'  --sort=name  --owner=0 --group=0 --numeric-owner --pax-option="exthdr.name=%d/PaxHeaders/%f,delete=atime,delete=ctime" --mtime="${commit_date}"  .
          # announce artifact for upload
          echo "FILE_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV

      - name: 'Checkout'
        uses: actions/checkout@v3
        with:
          repository: 'tbocek/obs-source-all'
          path: 'obs-source-all'
          fetch-depth: 0

      - name: 'Copy'
        run: |
          mv ../${{ env.FILE_NAME }} .
          git tag ${{ github.event.inputs.tag }} && git push origin ${{ github.event.inputs.tag }}

      - name: 'Release'
        uses: ncipollo/release-action@v1
        with:
          name: '${{ github.event.inputs.tag }}'
          owner: 'tbocek'
          repo: 'tbocek/obs-source-all'
          tag: '${{ github.event.inputs.tag }}'
          artifacts: '${{ env.FILE_NAME }}'

      - name: 'Upload source artifact'
        uses: actions/upload-artifact@v3
        with:
          name: 'obs-studio-source-${{ github.event.inputs.tag }}'
          path: '${{ github.workspace }}/${{ env.FILE_NAME }}'